# 文本分块正则表达式说明文档

- https://regex101.com/
- https://gist.github.com/hanxiao/3f60354cf6dc5ac698bc9154163b4e6a
- https://mp.weixin.qq.com/s/HsyEgqbhO2iqdJAGVs3pdA?version=4.1.31.99548&platform=mac&nwr_flag=1&from=industrynews#wechat_redirect

## 目录
1. [基础模式说明](#基础模式说明)
2. [文本模式详解](#文本模式详解)
3. [使用示例](#使用示例)
4. [注意事项](#注意事项)

## 基础模式说明

### 基础正则表达式组件

1. **避免开始字符** (`AVOID_AT_START`)
```python
[\s\]})>,']
```
- 用途：防止在特定字符后开始新的匹配
- 包含：空白字符、右括号、右花括号、右方括号、逗号、引号等

2. **标点符号** (`PUNCTUATION`)
```python
[.!?…]|\.{3}|[\u2026\u2047-\u2049]|[\p{Emoji_Presentation}\p{Extended_Pictographic}]
```
- 包含：
  - 基本标点：句号、感叹号、问号
  - 省略号：...或…
  - Unicode特殊标点：⁇-⁉
  - 表情符号：所有表情符号和扩展图形字符

3. **引用结束** (`QUOTE_END`)
```python
(?:'(?=`)|''(?=``))
```
- 匹配引用的结束标记
- 支持单引号和双引号的组合

4. **句子结束** (`SENTENCE_END`)
```python
(?:{PUNCTUATION}(?<!{AVOID_AT_START}(?={PUNCTUATION}))|{QUOTE_END})(?=\S|$)
```
- 匹配句子的结束位置
- 考虑标点符号和引用结束的组合

## 文本模式详解

### 1. 标题模式
```python
(?:^(?:[#*=-]{1,7}|\w[^\r\n]{0,200}\r?\n[-=]{2,200}|<h[1-6][^>]{0,100}>)[^\r\n]{1,200}(?:</h[1-6]>)?(?:\r?\n|$))
```
- 支持类型：
  - Markdown标题（#）
  - Setext风格标题（=== 或 ---）
  - HTML标题标签
- 示例：
  ```markdown
  # 一级标题
  二级标题
  --------
  <h3>三级标题</h3>
  ```

### 2. 引用标记
```python
(?:\[[0-9]+\][^\r\n]{1,800})
```
- 匹配文献引用标记
- 示例：`[1] 这是一个参考文献`

### 3. 列表项模式
```python
(?:(?:^|\r?\n)[ \t]{0,3}(?:[-*+•]|\d{1,3}\.\w\.|\[[ xX]\])[ \t]+...)
```
- 支持类型：
  - 无序列表（-、*、+、•）
  - 有序列表（1. 2. 3.）
  - 任务列表（[ ] [x] [X]）
- 支持多级嵌套（最多6级）
- 示例：
  ```markdown
  - 一级列表项
    * 二级列表项
      + 三级列表项
  1. 有序列表项
  [x] 已完成任务
  [ ] 未完成任务
  ```

### 4. 引用块模式
```python
(?:(?:^>(?:>|\s{2,}){0,2}...)\r?\n?){1,15})
```
- 支持多级嵌套引用
- 最多支持15行
- 示例：
  ```markdown
  > 一级引用
  >> 二级引用
  >>> 三级引用
  ```

### 5. 代码块模式
```python
(?:(?:^|\r?\n)(?:```|~~~)(?:\w{0,20})?\r?\n[\s\S]{0,1500}?(?:```|~~~)\r?\n?|...)
```
- 支持类型：
  - 围栏式代码块（```或~~~）
  - 缩进式代码块（4个空格或1个制表符）
  - HTML代码块（<pre>和<code>标签）
- 示例：
  ```markdown
  ```python
  def hello():
      print("Hello, World!")
  ```
  
      缩进式代码块
  
  <pre><code>HTML代码块</code></pre>
  ```

### 6. 表格模式
```python
(?:(?:^|\r?\n)(?:\|[^\r\n]{0,200}\|(?:\r?\n\|[-:]{1,200}\|){0,1}...)
```
- 支持：
  - Markdown表格
  - HTML表格
- 单元格长度限制：200字符
- 最大行数：20行
- 示例：
  ```markdown
  | 列1 | 列2 |
  |-----|-----|
  | 内容1 | 内容2 |
  ```

### 7-14. 其他模式
（按照相同格式继续描述其他模式...）

## 使用示例

### 基本使用
```python
from text_chunker import TextChunker

chunker = TextChunker()
chunks = chunker.process_file("input.txt")

for chunk in chunks:
    print(f"类型: {chunk.chunk_type}")
    print(f"内容: {chunk.content}\n")
```

### 处理表情符号
```python
text = "Hello! 👋 这是一个带表情符号的句子 😊"
chunks = chunker.process_text(text)
```

## 注意事项

1. **长度限制**
   - 每种模式都有其特定的长度限制
   - 超出限制的内容可能会被截断或分成多个块

2. **嵌套限制**
   - 列表最多支持6级嵌套
   - 引用块最多支持3级嵌套
   - 括号内容最多支持5级嵌套

3. **特殊字符处理**
   - 表情符号被视为句子边界
   - Unicode特殊字符都有适当的处理

4. **性能考虑**
   - 复杂的正则表达式可能影响性能
   - 建议对大文件进行分批处理
   - 可以根据需要调整各种限制参数

5. **编码要求**
   - 输入文件必须是UTF-8编码
   - 确保正确处理所有Unicode字符

## 维护和更新
最后更新日期：2024-02-06 